# OTUS-Postgre_DBA-2024-09
## Александр Грешнов

### Homework 5. Настройка PostgreSQL

#### Часть 1. Создание ВМ, установка PostgreSQL
1. В VirtualBox установлена ОС Debian. Установлен PostgreSQL 15. (см. [Homework 1](/Homework/HW-1.md)).
```
# Заходим под пользователем postgres
sudo su - postgres
# Созданные кластеры
pg_lsclusters
```
   ![image](https://github.com/user-attachments/assets/7dddaba5-068a-4465-aa48-f64e2737f4bf)\
2. Для возможности внешнего подключение из локальной сети был именен файл pg_hba.conf
```
# Файл конфигурации подключений
sudo nano /etc/postgresql/15/main/pg_hba.conf

# добавлена строка
# host    all             all             192.168.0.0/24         md5
# подключение по паролю (md5) с адресов 192.168.0.*

# Перезагрузка
sudo systemctl restart postgresql.service

# Вход под пользователем postgres
sudo su - postgres
psql

# Установка пароля пользоватлю postgres
ALTER USER postgres WITH PASSWORD 'postgres';

# Разрешение прослушивания портов (для доступа извне)
ALTER SYSTEM SET listen_addresses TO '*';
# Просмотр разрешений
show listen_addresses;

# Перезагрузка
sudo systemctl restart postgresql.service

```

![image](https://github.com/user-attachments/assets/ff273bce-6c61-4382-a21f-8ce8c94c36f2)\
![image](https://github.com/user-attachments/assets/dbe735eb-ac40-44ee-8c35-a9325e553243)

3. Текущие значения настроек
```
select * from pg_file_settings;
```
![image](https://github.com/user-attachments/assets/1e11a0a8-a962-47c4-bb37-0c138e9d8d04)

```
select * from pg_settings;
```
См. [Список настроек по-умолчанию](/Homework/ext/HW-5.pg_settings_default.html)

#### Часть 2. Нагрузка кластера через утилиту pgbench
1. Кластер нагружен через утилиту pgbench (https://postgrespro.ru/docs/postgrespro/14/pgbench). До настроек получили следующий показатель tps = **536.435490**.
```
sudo su - postgres
psql

# Создаём БД test
create database test;
\q

# Инициируем pgbench
pgbench -i test

# Запускаем pgbench
pgbench -c 50 -j 2 -P 10 -T 60 test
   
```
![image](https://github.com/user-attachments/assets/11c20267-e0f4-464e-9715-accebfa61685)\
![image](https://github.com/user-attachments/assets/c8ababdc-a249-492e-b1fe-a3bb71889005)


#### Часть 3. Настройка кластера PostgreSQL 15 на максимальную производительность
1. Предположим, что цель кластера - хранилище даных (DWH). Количество пользователей можо оставить по умолчанию (100 будет достаточно). Для начала получим информацию о технических характеристиках ВМ.
```
# Информация о процессоре
lscpu
# Информация о оперативной памяти
free -m

```
![image](https://github.com/user-attachments/assets/38c519ea-6853-4db0-9f24-216531dc6536)

2. Обратим внимание на наиболее важные настройки, зависящие от тех. характеристик ВМ. Воспользуемся онлайн сервисом [pgconfig.org](https://www.pgconfig.org/). Зададим входные параметры и получим настройки конфигурации.
   ![image](https://github.com/user-attachments/assets/92f1bae4-0987-4909-ad30-63a6c136f23e)
```
# Generated by PGConfig 3.1.4 (1fe6d98dedcaad1d0a114617cfd08b4fed1d8a01)
# https://api.pgconfig.org/v1/tuning/get-config?format=conf&include_pgbadger=true&log_format=csvlog&max_connections=100&pg_version=15&environment_name=DW&total_ram=3GB&cpus=2&drive_type=HDD&arch=x86-64&os_type=linux

# Memory Configuration
shared_buffers = 768MB
effective_cache_size = 2GB
work_mem = 15MB
maintenance_work_mem = 154MB

# Checkpoint Related Configuration
min_wal_size = 2GB
max_wal_size = 3GB
checkpoint_completion_target = 0.9
wal_buffers = -1

# Network Related Configuration
listen_addresses = '*'
max_connections = 100

# Storage Configuration
random_page_cost = 4.0
effective_io_concurrency = 2

# Worker Processes Configuration
max_worker_processes = 8
max_parallel_workers_per_gather = 2
max_parallel_workers = 2

# Logging configuration for pgbadger
logging_collector = on
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
lc_messages = 'C'

# Adjust the minimum time to collect the data
log_min_duration_statement = '10s'
log_autovacuum_min_duration = 0

# CSV Configuration
log_destination = 'csvlog'


```
3. Выполним запрос на обновления параметров и перезагрузим кластер. В результате сгенерирован файл  **/mnt/data/15/main/postgresql.auto.conf**. Из него будут подставляться значения при загрузке кластера.
<details>
   <summary>Запрос на изменение значений</summary>

```

-- Memory Configuration
ALTER SYSTEM SET shared_buffers TO '768MB';
ALTER SYSTEM SET effective_cache_size TO '2GB';
ALTER SYSTEM SET work_mem TO '15MB';
ALTER SYSTEM SET maintenance_work_mem TO '154MB';

-- Checkpoint Related Configuration
ALTER SYSTEM SET min_wal_size TO '2GB';
ALTER SYSTEM SET max_wal_size TO '3GB';
ALTER SYSTEM SET checkpoint_completion_target TO '0.9';
ALTER SYSTEM SET wal_buffers TO '-1';

-- Network Related Configuration
ALTER SYSTEM SET listen_addresses TO '*';
ALTER SYSTEM SET max_connections TO '100';

-- Storage Configuration
ALTER SYSTEM SET random_page_cost TO '4.0';
ALTER SYSTEM SET effective_io_concurrency TO '2';

-- Worker Processes Configuration
ALTER SYSTEM SET max_worker_processes TO '8';
ALTER SYSTEM SET max_parallel_workers_per_gather TO '2';
ALTER SYSTEM SET max_parallel_workers TO '2';

-- Logging configuration for pgbadger
ALTER SYSTEM SET logging_collector TO 'on';
ALTER SYSTEM SET log_checkpoints TO 'on';
ALTER SYSTEM SET log_connections TO 'on';
ALTER SYSTEM SET log_disconnections TO 'on';
ALTER SYSTEM SET log_lock_waits TO 'on';
ALTER SYSTEM SET log_temp_files TO '0';
ALTER SYSTEM SET lc_messages TO 'C';

-- Adjust the minimum time to collect the data
ALTER SYSTEM SET log_min_duration_statement TO '10s';
ALTER SYSTEM SET log_autovacuum_min_duration TO '0';

-- CSV Configuration
ALTER SYSTEM SET log_destination TO 'csvlog';

```
</details>

![image](https://github.com/user-attachments/assets/c33e18b7-b66b-4122-ab46-509a78fb6250)

<details>
   <summary>Описание наиболее важных параметров</summary>

   1. shared_buffers - Используется для кэширования данных. По умолчанию низкое значение (для поддержки как можно большего кол-ва ОС). Согласно документации, рекомендуемое значение для данного параметра - 25% от общей оперативной памяти на сервере. PostgreSQL использует 2 кэша - свой (изменяется shared_buffers) и ОС. Редко значение больше, чем 40% окажет влияние на производительность.
   
2. max_connections - Максимальное количество соединений. Для изменения данного параметра придётся перезапускать сервер. Если планируется использование PostgreSQL как DWH, то большое количество соединений не нужно. Данный параметр тесно связан с work_mem. Поэтому будьте пределено аккуратны с ним

3. effective_cache_size - Служит подсказкой для планировщика, сколько ОП у него в запасе. Можно определить как shared_buffers + ОП системы - ОП используемое самой ОС и другими приложениями. За счёт данного параметра планировщик может чаще использовать индексы, строить hash таблицы. Наиболее часто используемое значение 75% ОП от общей на сервере. 

4. work_mem - Используется для сортировок, построения hash таблиц. Это позволяет выполнять данные операции в памяти, что гораздо быстрее обращения к диску. В рамках одного запроса данный параметр может быть использован множество раз. Если ваш запрос содержит 5 операций сортировки, то память, которая потребуется для его выполнения уже как минимум work_mem * 5. Т.к. скорее-всего на сервере вы не одни и сессий много, то каждая из них может использовать этот параметр по нескольку раз, поэтому не рекомендуется делать его слишком большим. Можно выставить небольшое значение для глобального параметра в конфиге и потом, в случае сложных запросов, менять этот параметр локально (для текущей сессии)
   
6. maintenance_work_mem - Определяет максимальное количество ОП для операций типа VACUUM, CREATE INDEX, CREATE FOREIGN KEY. Увеличение этого параметра позволит быстрее выполнять эти операции. Не связано с work_mem поэтому можно ставить в разы больше, чем work_mem

7. wal_buffers - Объём разделяемой памяти, который будет использоваться для буферизации данных WAL, ещё не записанных на диск. Если у вас большое количество одновременных подключений, увеличение параметра улучшит производительность. По умолчанию -1, определяется автоматически, как 1/32 от shared_buffers, но не больше, чем 16 МБ (в ручную можно задавать большие значения). Обычно ставят 16 МБ.
  
8. max_wal_size - Максимальный размер, до которого может вырастать WAL между автоматическими контрольными точками в WAL. Значение по умолчанию — 1 ГБ. Увеличение этого параметра может привести к увеличению времени, которое потребуется для восстановления после сбоя, но позволяет реже выполнять операцию сбрасывания на диск. Так же сбрасывание может выполниться и при достижении нужного времени, определённого параметром checkpoint_timeout

9. checkpoint_timeout - Чем реже происходит сбрасывание, тем дольше будет восстановление БД после сбоя. Значение по умолчанию 5 минут, рекомендуемое - от 30 минут до часа. 
Необходимо "синхронизировать" два этих параметра. Для этого можно поставить checkpoint_timeout в выбранный промежуток, включить параметр log_checkpoints и по нему отследить, сколько было записано буферов. После чего подогнать параметр max_wal_size.

</details>

#### Часть 4. Нагрузка кластера через утилиту pgbench
1. Кластер нагружен через утилиту pgbench (https://postgrespro.ru/docs/postgrespro/14/pgbench). Значительных результатов повышения производительности тест не показал - tps = **535.858264**.. 
![image](https://github.com/user-attachments/assets/1cf2e28c-ed45-4896-a6d0-7cc66d272ae1)
```
2. Скорректируем настроечные значения на предел допустимости.

```
-- Memory Configuration
ALTER SYSTEM SET shared_buffers TO '2GB';
ALTER SYSTEM SET effective_cache_size TO '2.5GB';
ALTER SYSTEM SET work_mem TO '150MB';
ALTER SYSTEM SET maintenance_work_mem TO '2GB';

-- Checkpoint Related Configuration
ALTER SYSTEM SET min_wal_size TO '2GB';
ALTER SYSTEM SET max_wal_size TO '3GB';
ALTER SYSTEM SET checkpoint_completion_target TO '0.5';
ALTER SYSTEM SET wal_buffers TO '16Mb';

```

#### Часть 5. Результат
1. Удалось достичь значения tps ??, при этом установлены следующие параметры конфигурации, описанные выше. Выбор их конфигурирования основывается на их наибольшем влиянии на производительность кластера согласно официальной документации и рекомендаций, размещенным на [https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server](https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server)


